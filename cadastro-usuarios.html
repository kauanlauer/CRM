<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TI KL CRM - Cadastro de Usuários</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Date Picker -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />

    <!-- CSS Base -->
    <link href="./css/painel.css" rel="stylesheet" />

    <!-- Estilos específicos da página -->
    <style>
      /* Ajustes específicos para o formulário de cadastro */
      .auth-warning {
        background-color: #fff8e6;
        border-left: 4px solid var(--color-warning);
        padding: 1rem;
        border-radius: var(--radius);
      }

      /* Animação de shake para erro */
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(5px);
        }
      }

      .shake {
        animation: shake 0.5s;
      }

      .user-action {
        cursor: pointer;
        transition: var(--transition);
      }

      .user-action:hover {
        transform: translateY(-2px);
      }

      .user-action.delete:hover {
        color: var(--color-danger);
      }

      .table-container {
        background-color: var(--color-white);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        padding: var(--size-5);
        margin-top: var(--size-6);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
          <div class="position-sticky pt-3">
            <div class="text-center mb-4">
              <div class="sidebar-logo mx-auto">
                <i class="fas fa-desktop"></i>
              </div>
              <h4>KL CRM</h4>
              <p class="small">Serviços de TI</p>
            </div>

            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link" href="painel.html">
                  <i class="fas fa-tachometer-alt"></i>
                  Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" id="clientes-link">
                  <i class="fas fa-users"></i>
                  Clientes
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" id="servicos-link">
                  <i class="fas fa-tools"></i>
                  Serviços
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" id="ordens-link">
                  <i class="fas fa-clipboard-list"></i>
                  Ordens de Serviço
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="cadastro-usuarios.html">
                  <i class="fas fa-user-plus"></i>
                  Cadastrar Usuários
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="gerenciar_users.html">
                  <i class="fas fa-user-shield"></i>
                  Gerenciar Usuários
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" id="logout-btn">
                  <i class="fas fa-sign-out-alt"></i>
                  Sair
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <!-- Navbar topo -->
          <div
            class="d-flex justify-content-between align-items-center py-3 mb-4 border-bottom"
          >
            <h1 class="h2">
              <i class="fas fa-user-plus me-2"></i> Cadastro de Usuários
            </h1>
            <div class="d-flex align-items-center">
              <span class="me-3"
                >Usuário:
                <strong id="current-username">Carregando...</strong></span
              >
              <a
                href="#"
                id="logout-link"
                class="btn btn-outline-primary btn-sm"
              >
                <i class="fas fa-sign-out-alt me-1"></i> Sair
              </a>
            </div>
          </div>

          <!-- Alert para não autorizados -->
          <div id="auth-warning" class="alert auth-warning mb-4 d-none">
            <h5 class="mb-2">
              <i class="fas fa-exclamation-triangle me-2"></i> Acesso Restrito
            </h5>
            <p class="mb-0">
              Apenas o usuário administrador (<strong>kauanlauer</strong>) pode
              cadastrar novos usuários no sistema. Por favor, faça login com uma
              conta de administrador para acessar esta funcionalidade.
            </p>
          </div>

          <!-- Formulário e tabela -->
          <div class="row">
            <!-- Formulário de cadastro -->
            <div class="col-md-12 col-lg-6 mb-4">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">
                    <i class="fas fa-user-plus me-2"></i>Novo Usuário
                  </h5>
                </div>
                <div class="card-body">
                  <!-- Alertas -->
                  <div
                    id="success-alert"
                    class="alert alert-success d-none"
                    role="alert"
                  >
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="success-message"></span>
                  </div>

                  <div
                    id="error-alert"
                    class="alert alert-danger d-none"
                    role="alert"
                  >
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="error-message"></span>
                  </div>

                  <!-- Formulário -->
                  <form id="user-form">
                    <div class="mb-3">
                      <label for="username" class="form-label"
                        >Nome de Usuário</label
                      >
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="fas fa-user"></i
                        ></span>
                        <input
                          type="text"
                          class="form-control"
                          id="username"
                          placeholder="Digite o nome de usuário"
                          required
                        />
                      </div>
                      <div class="form-text">Nome para login no sistema</div>
                    </div>

                    <div class="mb-3">
                      <label for="password" class="form-label">Senha</label>
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="fas fa-lock"></i
                        ></span>
                        <input
                          type="password"
                          class="form-control"
                          id="password"
                          placeholder="Digite a senha"
                          required
                        />
                        <button
                          class="btn btn-outline-secondary toggle-password"
                          type="button"
                        >
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="fullname" class="form-label"
                        >Nome Completo</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="fullname"
                        placeholder="Digite o nome completo"
                        required
                      />
                    </div>

                    <div class="mb-3">
                      <label for="role" class="form-label">Cargo</label>
                      <select class="form-select" id="role" required>
                        <option value="">Selecione um cargo</option>
                        <option value="Administrador">Administrador</option>
                        <option value="Suporte">Suporte</option>
                        <option value="Técnico">Técnico</option>
                        <option value="Atendente">Atendente</option>
                      </select>
                    </div>

                    <div class="mb-3">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="temp-user"
                        />
                        <label class="form-check-label" for="temp-user">
                          <strong>Usuário Temporário</strong>
                        </label>
                      </div>
                      <div class="form-text">
                        Usuários temporários serão automaticamente excluídos
                        após a data de expiração
                      </div>
                    </div>

                    <div class="mb-3 d-none" id="expiration-group">
                      <label for="expiration-date" class="form-label"
                        >Data de Expiração</label
                      >
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="fas fa-calendar"></i
                        ></span>
                        <input
                          type="text"
                          class="form-control"
                          id="expiration-date"
                          placeholder="Selecione a data e hora"
                        />
                      </div>
                    </div>

                    <div class="d-grid mt-4">
                      <button
                        type="submit"
                        class="btn btn-primary"
                        id="save-btn"
                      >
                        <i class="fas fa-save me-2"></i> Cadastrar Usuário
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Tabela de usuários recém-cadastrados -->
            <div class="col-md-12 col-lg-6">
              <div class="card">
                <div
                  class="card-header d-flex justify-content-between align-items-center"
                >
                  <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Usuários Recentes
                  </h5>
                  <span class="badge bg-primary" id="user-count">0</span>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead>
                        <tr>
                          <th>Usuário</th>
                          <th>Nome</th>
                          <th>Cargo</th>
                          <th>Status</th>
                          <th>Ações</th>
                        </tr>
                      </thead>
                      <tbody id="users-table">
                        <tr>
                          <td colspan="5" class="text-center py-3">
                            Carregando usuários...
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="card-footer">
                  <a
                    href="gerenciar_users.html"
                    class="btn btn-outline-primary btn-sm"
                  >
                    <i class="fas fa-user-shield me-1"></i> Gerenciar Todos
                    Usuários
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Controles Mobile -->
    <button class="mobile-menu-toggle d-md-none">
      <i class="fas fa-bars"></i>
    </button>
    <div class="sidebar-overlay"></div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Date Picker -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Inicialização do cliente Supabase
        const SUPABASE_URL = "https://rdhftnrksrawaahoqgpo.supabase.co";
        const SUPABASE_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkaGZ0bnJrc3Jhd2FhaG9xZ3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5ODA3NDQsImV4cCI6MjA1NzU1Njc0NH0.v7ItKQTkx9TNGoPBIlsgcwYUQ3jA8PlY1SaIj6bH5qA";
        const supabaseClient = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_KEY
        );
      
        // Elementos do DOM
        const userForm = document.getElementById("user-form");
        const saveBtn = document.getElementById("save-btn");
        const usersTable = document.getElementById("users-table");
        const userCount = document.getElementById("user-count");
        const tempUserCheck = document.getElementById("temp-user");
        const expirationGroup = document.getElementById("expiration-group");
        const togglePasswordBtn = document.querySelector(".toggle-password");
        const passwordInput = document.getElementById("password");
        const authWarning = document.getElementById("auth-warning");
        const currentUsername = document.getElementById("current-username");
        const successAlert = document.getElementById("success-alert");
        const errorAlert = document.getElementById("error-alert");
        const successMessage = document.getElementById("success-message");
        const errorMessage = document.getElementById("error-message");
        const logoutBtn = document.getElementById("logout-btn");
        const logoutLink = document.getElementById("logout-link");
      
        // Variáveis globais
        let isAuthorized = false;
        let currentUser = null;
      
        // Inicializar o date picker
        const datePicker = flatpickr("#expiration-date", {
          enableTime: true,
          dateFormat: "Y-m-d H:i",
          minDate: "today",
          time_24hr: true,
          locale: "pt",
        });
      
        // Verificar autenticação
        function checkAuth() {
          const isAuthenticated = sessionStorage.getItem("authenticated");
          const username = sessionStorage.getItem("username");
      
          if (!isAuthenticated || !username) {
            window.location.href = "index.html";
            return;
          }
      
          currentUsername.textContent = username;
          currentUser = username;
      
          // Verificar se é o usuário autorizado
          if (username !== "kauanlauer") {
            authWarning.classList.remove("d-none");
            saveBtn.disabled = true;
            userForm.querySelectorAll("input, select").forEach((el) => {
              el.disabled = true;
            });
            isAuthorized = false;
          } else {
            authWarning.classList.add("d-none");
            saveBtn.disabled = false;
            isAuthorized = true;
          }
      
          // Carregar usuários
          loadUsers();
        }
      
        // Carregar usuários
        async function loadUsers() {
          try {
            const { data: users, error } = await supabaseClient
              .from("usuarios")
              .select("*")
              .order('data_criacao', { ascending: false });
      
            if (error) throw error;
      
            // Atualizar contador
            if (users) {
              userCount.textContent = users.length;
            }
      
            renderUsersTable(users);
          } catch (error) {
            console.error("Erro ao carregar usuários:", error);
            showAlert("Erro ao carregar a lista de usuários: " + error.message, "error");
          }
        }
      
        // Renderizar tabela de usuários
        function renderUsersTable(users) {
          if (!users || users.length === 0) {
            usersTable.innerHTML =
              '<tr><td colspan="5" class="text-center py-3">Nenhum usuário cadastrado recentemente.</td></tr>';
            return;
          }
      
          const currentDate = new Date();
          let html = "";
      
          users.forEach((user) => {
            const isExpired =
              user.data_expiracao &&
              new Date(user.data_expiracao) < currentDate;
            const isTemporary = user.is_temporario;
      
            let statusBadge = "";
            if (isExpired) {
              statusBadge = '<span class="badge bg-danger">Expirado</span>';
            } else if (isTemporary) {
              statusBadge = '<span class="badge bg-warning">Temporário</span>';
            } else {
              statusBadge = '<span class="badge bg-success">Ativo</span>';
            }
      
            html += `
            <tr>
              <td>${user.username}</td>
              <td>${user.nome_completo || "-"}</td>
              <td>${user.cargo || "-"}</td>
              <td>${statusBadge}</td>
              <td>
                ${
                  isAuthorized
                    ? `
                  <i class="fas fa-trash-alt user-action delete" data-id="${user.id}" title="Excluir usuário"></i>
                `
                    : "-"
                }
              </td>
            </tr>
          `;
          });
      
          usersTable.innerHTML = html;
      
          // Adicionar event listeners aos botões de ação
          if (isAuthorized) {
            document.querySelectorAll(".user-action.delete").forEach((btn) => {
              btn.addEventListener("click", function () {
                const userId = this.getAttribute("data-id");
                deleteUser(userId);
              });
            });
          }
        }
      
        // Cadastrar novo usuário
        async function saveUser(userData) {
          try {
            // Usar o método rpc para contornar as políticas de segurança RLS
            const { data, error } = await supabaseClient
              .rpc('insert_usuario', {
                p_username: userData.username,
                p_password: userData.password,
                p_nome_completo: userData.nome_completo,
                p_cargo: userData.cargo,
                p_is_temporario: userData.is_temporario,
                p_data_expiracao: userData.data_expiracao
              });
        
            if (error) throw error;
        
            // Resetar formulário
            userForm.reset();
            expirationGroup.classList.add("d-none");
        
            // Mostrar mensagem de sucesso
            showAlert("Usuário cadastrado com sucesso!", "success");
        
            // Recarregar usuários
            loadUsers();
        
            return true;
          } catch (error) {
            console.error("Erro ao cadastrar usuário:", error);
        
            if (error.code === "23505") {
              showAlert(
                "Nome de usuário já existe. Por favor, escolha outro nome de usuário.",
                "error"
              );
            } else {
              showAlert("Erro ao cadastrar usuário: " + error.message, "error");
            }
        
            return false;
          }
        }
      
        // Excluir usuário
        async function deleteUser(userId) {
          if (!confirm("Tem certeza que deseja excluir este usuário?")) return;
        
          try {
            const { error } = await supabaseClient
              .rpc('delete_usuario', { 
                p_user_id: userId 
              });
        
            if (error) throw error;
        
            showAlert("Usuário excluído com sucesso!", "success");
            loadUsers();
          } catch (error) {
            console.error("Erro ao excluir usuário:", error);
            showAlert("Erro ao excluir usuário: " + error.message, "error");
          }
        }
        
      
        // Mostrar alerta
        function showAlert(message, type) {
          if (type === "success") {
            successMessage.textContent = message;
            successAlert.classList.remove("d-none");
            errorAlert.classList.add("d-none");
      
            // Esconder após 3 segundos
            setTimeout(() => {
              successAlert.classList.add("d-none");
            }, 3000);
          } else {
            errorMessage.textContent = message;
            errorAlert.classList.remove("d-none");
            successAlert.classList.add("d-none");
      
            // Adicionar animação de shake
            errorAlert.classList.add("shake");
            setTimeout(() => {
              errorAlert.classList.remove("shake");
            }, 500);
      
            // Esconder após 5 segundos
            setTimeout(() => {
              errorAlert.classList.add("d-none");
            }, 5000);
          }
        }
      
        // Formatar data
        function formatDate(dateString) {
          if (!dateString) return "-";
      
          const date = new Date(dateString);
          return new Intl.DateTimeFormat("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          }).format(date);
        }
      
        // Event listeners
      
        // Toggle de usuário temporário
        tempUserCheck.addEventListener("change", function () {
          if (this.checked) {
            expirationGroup.classList.remove("d-none");
          } else {
            expirationGroup.classList.add("d-none");
          }
        });
      
        // Toggle de visibilidade da senha
        togglePasswordBtn.addEventListener("click", function () {
          const type =
            passwordInput.getAttribute("type") === "password"
              ? "text"
              : "password";
          passwordInput.setAttribute("type", type);
          this.querySelector("i").classList.toggle("fa-eye");
          this.querySelector("i").classList.toggle("fa-eye-slash");
        });
      
        // Logout
        function handleLogout() {
          // Limpar dados de autenticação
          sessionStorage.removeItem("authenticated");
          sessionStorage.removeItem("username");
      
          // Redirecionar para a página de login
          window.location.href = "index.html";
        }
      
        logoutBtn.addEventListener("click", handleLogout);
        logoutLink.addEventListener("click", handleLogout);
      
        // Submissão do formulário
        userForm.addEventListener("submit", async function (e) {
          e.preventDefault();
      
          if (!isAuthorized) {
            showAlert(
              "Você não tem permissão para cadastrar usuários.",
              "error"
            );
            return;
          }
      
          // Obter valores do formulário
          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value.trim();
          const fullname = document.getElementById("fullname").value.trim();
          const role = document.getElementById("role").value;
          const isTemporary = document.getElementById("temp-user").checked;
          const expirationDate = document.getElementById("expiration-date").value;
      
          // Validações
          if (!username || !password || !fullname || !role) {
            showAlert("Preencha todos os campos obrigatórios.", "error");
            return;
          }
      
          if (isTemporary && !expirationDate) {
            showAlert(
              "Para usuários temporários, informe a data de expiração.",
              "error"
            );
            return;
          }
      
          // Preparar dados do usuário
          const userData = {
            username: username,
            password: password,
            nome_completo: fullname,
            cargo: role,
            is_temporario: isTemporary,
            data_expiracao: isTemporary ? new Date(expirationDate).toISOString() : null
          };
      
          // Salvar usuário
          await saveUser(userData);
        });
      
        // Menu mobile toggle
        const menuToggle = document.querySelector(".mobile-menu-toggle");
        const sidebar = document.querySelector(".sidebar");
        const overlay = document.querySelector(".sidebar-overlay");
      
        if (menuToggle && sidebar && overlay) {
          menuToggle.addEventListener("click", function () {
            sidebar.classList.toggle("show");
            overlay.classList.toggle("show");
          });
      
          overlay.addEventListener("click", function () {
            sidebar.classList.remove("show");
            overlay.classList.remove("show");
          });
        }
      
        // Inicializar a página
        checkAuth();
      
        // Verificar e remover usuários expirados
       // Corrigir a função saveUser - problema na passagem de parâmetros para o RPC
async function saveUser(userData) {
  try {
    // Usar o método rpc para contornar as políticas de segurança RLS
    const { data, error } = await supabaseClient
      .rpc('insert_usuario', {
        p_username: userData.username,
        p_password: userData.password,
        p_nome_completo: userData.nome_completo,
        p_cargo: userData.cargo,
        p_is_temporario: userData.is_temporario,
        p_data_expiracao: userData.data_expiracao
      });

    if (error) throw error;

    // Resetar formulário
    userForm.reset();
    expirationGroup.classList.add("d-none");

    // Mostrar mensagem de sucesso
    showAlert("Usuário cadastrado com sucesso!", "success");

    // Recarregar usuários
    loadUsers();

    return true;
  } catch (error) {
    console.error("Erro ao cadastrar usuário:", error);

    if (error.code === "23505") {
      showAlert(
        "Nome de usuário já existe. Por favor, escolha outro nome de usuário.",
        "error"
      );
    } else {
      showAlert("Erro ao cadastrar usuário: " + error.message, "error");
    }

    return false;
  }
}

// Corrigir a função deleteUser - problema na passagem de parâmetros para o RPC
async function deleteUser(userId) {
  if (!confirm("Tem certeza que deseja excluir este usuário?")) return;

  try {
    const { error } = await supabaseClient
      .rpc('delete_usuario', { 
        p_user_id: userId 
      });

    if (error) throw error;

    showAlert("Usuário excluído com sucesso!", "success");
    loadUsers();
  } catch (error) {
    console.error("Erro ao excluir usuário:", error);
    showAlert("Erro ao excluir usuário: " + error.message, "error");
  }
}

// Corrigir a função checkExpiredUsers - problema na passagem de parâmetros para o RPC
async function checkExpiredUsers() {
  if (!isAuthorized) return;

  try {
    const currentDate = new Date().toISOString();

    const { data: expiredUsers, error } = await supabaseClient
      .rpc('get_expired_users', { 
        p_current_date: currentDate 
      });

    if (error) throw error;

    if (expiredUsers && expiredUsers.length > 0) {
      console.log(
        `Encontrados ${expiredUsers.length} usuários expirados para remoção.`
      );

      // Remover usuários expirados usando stored procedure
      const { error: deleteError } = await supabaseClient
        .rpc('remove_expired_users', { 
          p_current_date: currentDate 
        });

      if (deleteError) throw deleteError;

      console.log(
        `${expiredUsers.length} usuários expirados foram removidos.`
      );

      showAlert(
        `${expiredUsers.length} usuários temporários expirados foram removidos automaticamente.`,
        "success"
      );
      loadUsers();
    }
  } catch (error) {
    console.error("Erro ao verificar usuários expirados:", error);
  }
}
function checkAuth() {
  const isAuthenticated = sessionStorage.getItem("authenticated");
  const username = sessionStorage.getItem("username");

  console.log("Verificando autenticação:", { isAuthenticated, username });

  if (!isAuthenticated || !username) {
    window.location.href = "index.html";
    return;
  }

  currentUsername.textContent = username;
  currentUser = username;

  // Verificar se é o usuário autorizado
  if (username !== "kauanlauer") {
    console.log("Usuário não autorizado:", username);
    authWarning.classList.remove("d-none");
    saveBtn.disabled = true;
    userForm.querySelectorAll("input, select").forEach((el) => {
      el.disabled = true;
    });
    isAuthorized = false;
  } else {
    console.log("Usuário autorizado:", username);
    authWarning.classList.add("d-none");
    saveBtn.disabled = false;
    isAuthorized = true;
  }

  // Carregar usuários
  loadUsers();
}
        // Verificar usuários expirados na inicialização
        setTimeout(checkExpiredUsers, 1000);
      
        // Verificar a cada 10 minutos
        setInterval(checkExpiredUsers, 10 * 60 * 1000);
      });
    </script>
  </body>
</html>
